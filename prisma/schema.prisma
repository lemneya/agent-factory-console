// Prisma schema for Agent Factory Console
// Single pane of glass dashboard for multi-agent AI development

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  image         String?
  emailVerified DateTime?
  accounts      Account[]
  sessions      Session[]
  projects      Project[]
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Project {
  id               String            @id @default(cuid())
  userId           String
  user             User              @relation(fields: [userId], references: [id])
  repoName         String
  repoFullName     String
  description      String?
  htmlUrl          String
  lastUpdated      DateTime
  runs             Run[]
  events           GitHubEvent[]
  councilDecisions CouncilDecision[]
  // AFC-1.2: Asset Registry relations
  assets           ProjectAsset[]
  // AFC-1.6: Memory Layer relations
  memoryItems      MemoryItem[]
  memoryPolicy     MemoryPolicy?
  // AFC-RUNNER-UX-3: Project Repo Binding
  repoOwner        String?
  baseBranch       String?           @default("main")
  createdAt        DateTime          @default(now())
}

model Repository {
  id            String        @id @default(cuid())
  githubId      Int           @unique
  name          String
  fullName      String
  description   String?
  htmlUrl       String
  cloneUrl      String?
  sshUrl        String?
  defaultBranch String?
  language      String?
  private       Boolean       @default(false)
  lastPushAt    DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  pullRequests  PullRequest[]
  issues        Issue[]
}

model PullRequest {
  id              String    @id @default(cuid())
  repositoryId    String
  repository      Repository @relation(fields: [repositoryId], references: [id])
  number          Int
  githubId        Int
  title           String
  body            String?   @db.Text
  state           String
  htmlUrl         String
  authorUsername  String
  authorAvatarUrl String?
  headRef         String
  baseRef         String
  merged          Boolean   @default(false)
  mergedAt        DateTime?
  createdAt       DateTime
  updatedAt       DateTime
  closedAt        DateTime?

  @@unique([repositoryId, number])
}

model Issue {
  id              String    @id @default(cuid())
  repositoryId    String
  repository      Repository @relation(fields: [repositoryId], references: [id])
  number          Int
  githubId        Int
  title           String
  body            String?   @db.Text
  state           String
  htmlUrl         String
  authorUsername  String
  authorAvatarUrl String?
  labels          String[]
  createdAt       DateTime
  updatedAt       DateTime
  closedAt        DateTime?

  @@unique([repositoryId, number])
}

model Run {
  id              String              @id @default(cuid())
  projectId       String
  project         Project             @relation(fields: [projectId], references: [id])
  name            String
  status          String              @default("ACTIVE")
  threadId        String              @default(cuid()) // AFC-1.1: threadId = runId always
  tasks           Task[]
  checkpoints     RunCheckpoint[]
  // AFC-1.4: Ralph Mode fields
  policy          RunPolicy?
  iterations      RunIteration[]
  abortReason     RunAbortReason?
  ralphMode       Boolean             @default(false)
  // AFC-1.6: Memory Layer relations
  memorySnapshots RunMemorySnapshot[]
  createdAt       DateTime            @default(now())
  completedAt     DateTime?

  @@index([threadId])
}

// AFC-1.1: RunCheckpoint for deterministic pause/resume
model RunCheckpoint {
  id           String         @id @default(cuid())
  runId        String
  run          Run            @relation(fields: [runId], references: [id], onDelete: Cascade)
  threadId     String         // MUST equal runId for AFC-1.1
  graphVersion String
  graphHash    String?
  checkpointId String
  nextNode     String?
  status       String         // RunStatus value
  stateJson    Json           // entire RunState "values" payload
  iterations   RunIteration[] // AFC-1.4: Iterations that created this checkpoint
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  @@index([runId])
  @@index([threadId])
}

model Task {
  id               String            @id @default(cuid())
  runId            String
  run              Run               @relation(fields: [runId], references: [id])
  title            String
  description      String?           @db.Text
  status           String            @default("TODO")
  priority         Int               @default(0)
  assignee         String?
  workerId         String?
  worker           Worker?           @relation(fields: [workerId], references: [id])
  result           Json?
  errorMsg         String?           @db.Text
  startedAt        DateTime?
  completedAt      DateTime?
  // AFC-1.1: Queue lease self-healing fields
  claimedBy        String?           // worker ID that claimed this task
  claimedAt        DateTime?         // when the task was claimed
  leaseExpiresAt   DateTime?         // when the lease expires (reclaimable after)
  attempts         Int               @default(0) // number of claim attempts
  // AFC-1.2: Asset integration fields
  assetVersionId   String?
  assetVersion     AssetVersion?     @relation(fields: [assetVersionId], references: [id])
  kind             String            @default("BUILD_CUSTOM") // INTEGRATE_ASSET | BUILD_CUSTOM | RESEARCH | QA
  // AFC-1.3: Council decision link
  councilDecisions CouncilDecision[]
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  @@index([status])
  @@index([leaseExpiresAt])
  @@index([assetVersionId])
}

// Worker model for Agent B implementation
// Workers are AI agents that can claim and execute tasks
model Worker {
  id           String    @id @default(cuid())
  name         String
  type         String    @default("AGENT")
  status       String    @default("IDLE")
  capabilities String[]
  metadata     Json?
  lastHeartbeat DateTime @default(now())
  currentTaskId String?  @unique
  tasks        Task[]
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
}

// WorkerLog tracks worker activity history
// AFC-1.1: Added parentId for nested logs (pods/subagents)
model WorkerLog {
  id        String      @id @default(cuid())
  workerId  String
  taskId    String?
  parentId  String?     // AFC-1.1: parent log ID for nested structure
  parent    WorkerLog?  @relation("LogHierarchy", fields: [parentId], references: [id])
  children  WorkerLog[] @relation("LogHierarchy")
  action    String
  details   Json?
  createdAt DateTime    @default(now())

  @@index([workerId])
  @@index([taskId])
  @@index([parentId])
}

model GitHubEvent {
  id              String   @id @default(cuid())
  deliveryId      String?
  projectId       String?
  project         Project? @relation(fields: [projectId], references: [id])
  repositoryId    String?
  repositoryName  String
  eventType       String
  action          String?
  senderUsername  String
  senderAvatarUrl String?
  payload         Json
  receivedAt      DateTime @default(now())
}

// ============================================================================
// AFC-1.3: Adoptability Council Models
// ============================================================================

// CouncilDecision: Mandatory research gate decision before BUILD tasks
model CouncilDecision {
  id              String       @id @default(cuid())
  projectId       String
  project         Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  taskId          String?
  task            Task?        @relation(fields: [taskId], references: [id])
  
  decision        String       // APPROVED | REJECTED | NEEDS_REVISION
  rationale       String?      @db.Text
  evidenceJson    Json?        // Links to research logs, benchmarks, etc.
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@index([projectId])
  @@index([taskId])
}

// ============================================================================
// AFC-1.4: Ralph Mode Models
// ============================================================================

// RunPolicy: Configuration for Ralph Mode execution
model RunPolicy {
  id                String   @id @default(cuid())
  runId             String   @unique
  run               Run      @relation(fields: [runId], references: [id], onDelete: Cascade)
  
  maxIterations     Int      @default(5)
  autoAbortOnFailure Boolean  @default(true)
  requireHumanReview Boolean  @default(false)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

// RunIteration: Tracks individual Ralph Mode loops
model RunIteration {
  id              String         @id @default(cuid())
  runId           String
  run             Run            @relation(fields: [runId], references: [id], onDelete: Cascade)
  checkpointId    String?
  checkpoint      RunCheckpoint? @relation(fields: [checkpointId], references: [id])
  
  iterationNumber Int
  inputJson       Json?
  outputJson      Json?
  status          String         // SUCCESS | FAILURE | IN_PROGRESS
  
  createdAt       DateTime       @default(now())
}

// RunAbortReason: Why a Ralph Mode run was aborted
model RunAbortReason {
  id        String   @id @default(cuid())
  runId     String   @unique
  run       Run      @relation(fields: [runId], references: [id], onDelete: Cascade)
  
  reason    String   @db.Text
  code      String?  // MAX_ITERATIONS | SYSTEM_ERROR | HUMAN_ABORT
  
  createdAt DateTime @default(now())
}

// ============================================================================
// AFC-1.6: Memory Layer Models
// ============================================================================

// MemoryItem: Individual unit of knowledge (code snippet, doc, decision)
model MemoryItem {
  id          String                  @id @default(cuid())
  projectId   String
  project     Project                 @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  // Content
  content     String                  @db.Text
  summary     String?                 @db.Text
  category    MemoryCategory          @default(CUSTOM)
  scope       MemoryScope             @default(PROJECT)
  
  // Vector search metadata (actual embedding stored in separate vector DB if needed, 
  // but we track metadata here for relational queries)
  tags        String[]
  metadata    Json?
  
  // Scoring & Retention
  score       Float                   @default(1.0)
  accessCount Int                     @default(0)
  lastUsedAt  DateTime?
  expiresAt   DateTime?
  
  // Relations
  accessLogs  MemoryAccessLog[]
  snapshots   RunMemorySnapshotItem[]
  
  createdAt   DateTime                @default(now())
  updatedAt   DateTime                @updatedAt

  @@index([projectId])
  @@index([category])
  @@index([scope])
}

enum MemoryCategory {
  CODE
  DOCUMENTATION
  DECISION
  ERROR
  CONTEXT
  CUSTOM
}

enum MemoryScope {
  GLOBAL
  PROJECT
  RUN
  USER
}

// MemoryAccessLog: Tracks when and how memory was used
model MemoryAccessLog {
  id           String     @id @default(cuid())
  memoryItemId String
  memoryItem   MemoryItem @relation(fields: [memoryItemId], references: [id], onDelete: Cascade)
  
  runId        String?
  action       String     // QUERY | RETRIEVE | UPDATE | DELETE
  relevance    Float?     // How relevant was this item to the query (0-1)
  
  usedAt       DateTime   @default(now())

  @@index([memoryItemId])
  @@index([runId])
  @@index([usedAt])
}

// MemoryPolicy: Project-level memory configuration
model MemoryPolicy {
  id                String           @id @default(cuid())
  projectId         String           @unique
  project           Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // Budget enforcement
  maxItems          Int              @default(1000)    // Max memory items per project
  maxTokensPerQuery Int              @default(4000)    // Max tokens in query response
  maxTokensTotal    Int              @default(100000)  // Max total tokens stored

  // Scope filtering
  enabledScopes     Json             @default("[\"PROJECT\", \"RUN\"]") // Enabled scopes

  // Category filtering
  enabledCategories Json             @default("[\"CODE\", \"DOCUMENTATION\", \"DECISION\", \"ERROR\", \"CONTEXT\", \"CUSTOM\"]")

  // Retention settings
  defaultTtlDays    Int?             // Default expiration in days
  autoArchiveDays   Int?             // Auto-archive after N days of no access

  // Deduplication settings
  dedupeEnabled     Boolean          @default(true)
  similarityThreshold Float          @default(0.95) // For fuzzy dedupe (future)

  // Scoring settings
  decayFactor       Float            @default(0.99)  // Daily score decay
  accessBoost       Float            @default(0.1)   // Score boost per access

  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  @@index([projectId])
}

// RunMemorySnapshot: Point-in-time snapshot of memory state for a run
model RunMemorySnapshot {
  id           String                   @id @default(cuid())
  runId        String
  run          Run                      @relation(fields: [runId], references: [id], onDelete: Cascade)

  name         String?                  // Optional snapshot name
  description  String?                  // Why snapshot was taken

  totalItems   Int                      @default(0)
  totalTokens  Int                      @default(0)

  items        RunMemorySnapshotItem[]

  metadata     Json?                    // Additional metadata

  snapshotAt   DateTime                 @default(now())
  createdAt    DateTime                 @default(now())

  @@index([runId])
  @@index([snapshotAt])
}

// RunMemorySnapshotItem: Join table for snapshot items
model RunMemorySnapshotItem {
  id           String              @id @default(cuid())
  snapshotId   String
  snapshot     RunMemorySnapshot   @relation(fields: [snapshotId], references: [id], onDelete: Cascade)
  memoryItemId String
  memoryItem   MemoryItem          @relation(fields: [memoryItemId], references: [id], onDelete: Cascade)

  scoreAtSnapshot Float            // Score at time of snapshot

  @@unique([snapshotId, memoryItemId])
  @@index([snapshotId])
  @@index([memoryItemId])
}


// ============================================================================
// UX-GATE-COPILOT-0: Copilot Audit Logging
// ============================================================================

// CopilotMessage: Audit log for all Copilot interactions
model CopilotMessage {
  id          String              @id @default(cuid())
  createdAt   DateTime            @default(now())
  
  userId      String?             // nullable if demo/signed-out
  projectId   String?             // nullable - scope context
  runId       String?             // nullable - scope context
  
  role        CopilotRole         // USER | ASSISTANT
  content     String              @db.Text
  sourcesJson Json?               // nullable - sources for assistant messages
  
  @@index([userId])
  @@index([projectId])
  @@index([runId])
  @@index([createdAt])
}

enum CopilotRole {
  USER
  ASSISTANT
}


// ============================================================================
// UX-GATE-COPILOT-1: Copilot Draft Mode
// ============================================================================

// CopilotDraft: Stores draft records for Blueprint/WorkOrders/Council
model CopilotDraft {
  id          String            @id @default(cuid())
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  userId      String?           // nullable if demo mode
  projectId   String?           // nullable - context
  runId       String?           // nullable - context

  kind        CopilotDraftKind  // BLUEPRINT | WORKORDERS | COUNCIL
  status      CopilotDraftStatus @default(DRAFT)

  title       String
  payloadJson Json              // The structured draft payload
  sourcesJson Json?             // Sources/citations (same schema as Copilot-0)

  approvedAt  DateTime?
  approvedBy  String?           // userId who approved
  resultRef   String?           // e.g., "Blueprint:abc123" / "CouncilDecision:xyz789"

  events      CopilotDraftEvent[]

  @@index([projectId])
  @@index([runId])
  @@index([createdAt])
  @@index([status])
  @@index([kind])
}

// CopilotDraftEvent: Audit trail for draft lifecycle
model CopilotDraftEvent {
  id          String                  @id @default(cuid())
  createdAt   DateTime                @default(now())

  draftId     String
  draft       CopilotDraft            @relation(fields: [draftId], references: [id], onDelete: Cascade)

  actorUserId String?                 // nullable if system action
  eventType   CopilotDraftEventType

  detailsJson Json?                   // Additional event details

  @@index([draftId])
  @@index([createdAt])
}

enum CopilotDraftKind {
  BLUEPRINT
  WORKORDERS
  COUNCIL
}

enum CopilotDraftStatus {
  DRAFT
  APPROVED
  REJECTED
  EXPIRED
  PENDING
}

enum CopilotDraftEventType {
  CREATED
  UPDATED
  APPROVED
  REJECTED
  EXPIRED
}

// ============================================================================
// UX-GATE-COPILOT-2: Blueprint & WorkOrder Models
// ============================================================================

// Blueprint: Defines a reusable project specification
model Blueprint {
  id          String             @id @default(cuid())
  name        String
  description String?            @db.Text
  projectId   String?
  
  versions    BlueprintVersion[]
  workOrders  WorkOrder[]
  
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt

  @@index([projectId])
  @@index([name])
}

// BlueprintVersion: Immutable snapshot of a Blueprint specification
model BlueprintVersion {
  id          String     @id @default(cuid())
  blueprintId String
  blueprint   Blueprint  @relation(fields: [blueprintId], references: [id], onDelete: Cascade)
  
  payloadJson Json       // { modules: [{ key, title, domain, spec }] }
  specHash    String     // SHA-256 hash for determinism verification
  
  workOrders  WorkOrder[]
  
  createdAt   DateTime   @default(now())

  @@index([blueprintId])
  @@index([specHash])
}

// WorkOrder: Individual unit of work derived from a Blueprint
model WorkOrder {
  id                String            @id @default(cuid())
  blueprintId       String?
  blueprint         Blueprint?        @relation(fields: [blueprintId], references: [id])
  blueprintVersionId String?
  blueprintVersion  BlueprintVersion? @relation(fields: [blueprintVersionId], references: [id])
  
  key               String            // Stable key for determinism (e.g., "auth-module")
  domain            String            // Domain category (e.g., "auth", "crud", "ui")
  title             String
  spec              String?           @db.Text
  dependsOn         String[]          // Keys of dependent work orders
  
  status            WorkOrderStatus   @default(PENDING)
  runId             String?           // Associated run when executed
  
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@index([blueprintId])
  @@index([blueprintVersionId])
  @@index([status])
  @@index([runId])
}

enum WorkOrderStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
  SKIPPED
}

// ============================================================================
// AFC-1.2: Asset Registry Models
// ============================================================================

// Asset: Reusable component definition (e.g., "nextauth-rbac", "crud-prisma")
model Asset {
  id             String         @id @default(cuid())
  slug           String         @unique // e.g. "nextauth-rbac", "crud-prisma"
  name           String
  description    String?        @db.Text
  category       String         // auth, crud, ui, infra, worker, etc.
  defaultLicense String         @default("MIT") // MIT, Apache-2.0, etc.
  versions       AssetVersion[]
  tags           AssetTag[]
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
}

// AssetVersion: Specific version of an asset with installation recipe
model AssetVersion {
  id            String         @id @default(cuid())
  assetId       String
  asset         Asset          @relation(fields: [assetId], references: [id], onDelete: Cascade)
  version       String         // semver: "1.0.0", "2.1.3"
  stackCompat   Json           // e.g. { "nextjs": ">=14", "prisma": "^5" }
  source        Json           // e.g. { "type": "repo_path", "ref": "assets/nextauth-rbac" }
  installRecipe Json           // steps + commands + files to copy
  interfacesRef String?        // path to INTERFACES.md
  boundariesRef String?        // path to BOUNDARIES.md
  proofPack     Json?          // e.g. { "type": "evidence_path", "ref": "evidence/assets/nextauth-rbac/v1" }
  status        String         @default("ACTIVE") // ACTIVE | DEPRECATED
  projectAssets ProjectAsset[]
  tasks         Task[]
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  @@unique([assetId, version])
}

// AssetTag: Searchable tags for assets
model AssetTag {
  id      String @id @default(cuid())
  assetId String
  asset   Asset  @relation(fields: [assetId], references: [id], onDelete: Cascade)
  tag     String

  @@index([tag])
  @@index([assetId])
}

// ProjectAsset: Links a project to a specific asset version
model ProjectAsset {
  id             String       @id @default(cuid())
  projectId      String
  project        Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  assetVersionId String
  assetVersion   AssetVersion @relation(fields: [assetVersionId], references: [id])
  pinned         Boolean      @default(true) // if true, don't auto-upgrade
  config         Json?        // project-specific configuration params
  createdAt      DateTime     @default(now())

  @@unique([projectId, assetVersionId])
}


// ============================================================================
// AFC-RUNNER-0: Build-to-PR Execution Engine
// ============================================================================

// ExecutionRun: Tracks a complete execution cycle from WorkOrders to PR
model ExecutionRun {
  id          String          @id @default(cuid())
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  completedAt DateTime?

  // Target repository info
  targetRepoOwner String
  targetRepoName  String
  targetBranch    String        @default("main")
  sourceBranch    String        // Branch created for changes (e.g., "afc/wo-123-auth")

  // Execution state
  status          ExecutionStatus @default(PENDING)
  errorMessage    String?       @db.Text

  // WorkOrders being executed
  workOrderIds    String[]

  // PR result
  prNumber        Int?
  prUrl           String?
  prTitle         String?
  prBody          String?       @db.Text

  // Evidence and logs
  cloneLog        String?       @db.Text
  buildLog        String?       @db.Text
  testLog         String?       @db.Text
  prCreationLog   String?       @db.Text
  evidencePath    String?       // Path to evidence folder

  // User/session context
  userId          String?
  projectId       String?

  // Safety gate references
  councilDecisionId    String?
  requiresBreakGlass   Boolean   @default(false)
  breakGlassApprovedAt DateTime?
  breakGlassApprovedBy String?

  // Execution logs relation
  logs            ExecutionLog[]

  @@index([status])
  @@index([userId])
  @@index([projectId])
  @@index([createdAt])
}

// ExecutionLog: Detailed log entries for execution phases
model ExecutionLog {
  id              String       @id @default(cuid())
  createdAt       DateTime     @default(now())
  executionRunId  String
  executionRun    ExecutionRun @relation(fields: [executionRunId], references: [id], onDelete: Cascade)
  phase           String       // CLONE, APPLY, BUILD, TEST, PR_CREATE
  level           String       @default("INFO") // INFO, WARN, ERROR, DEBUG
  message         String       @db.Text
  detailsJson     Json?

  @@index([executionRunId])
  @@index([phase])
  @@index([createdAt])
}

enum ExecutionStatus {
  PENDING
  CLONING
  APPLYING
  BUILDING
  TESTING
  CREATING_PR
  COMPLETED
  FAILED
}

// ============================================================================
// AFC-C2-STREAM-0: Command & Control Dashboard
// ============================================================================

// C2Session: Active command & control session for multi-agent orchestration
model C2Session {
  id          String        @id @default(cuid())
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  userId      String?       // nullable for demo mode
  projectId   String?       // optional project context

  name        String        @default("Unnamed Session")
  status      C2SessionStatus @default(IDLE)

  // Simulation config
  agentCount  Int           @default(20)
  gridRows    Int           @default(4)
  gridCols    Int           @default(5)

  // Timing
  startedAt   DateTime?
  stoppedAt   DateTime?

  // Relations
  events      C2Event[]
  artifacts   C2Artifact[]

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

// C2Event: Real-time event emitted during C2 session
model C2Event {
  id          String        @id @default(cuid())
  createdAt   DateTime      @default(now())

  sessionId   String
  session     C2Session     @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  type        C2EventType
  payload     Json          // Event-specific data

  // For agent state updates
  agentIndex  Int?          // 0-19 for 20 agents
  agentState  C2AgentState?

  // For progress updates
  progress    Float?        // 0-100

  // For log entries
  level       String?       // INFO, WARN, ERROR, DEBUG
  message     String?       @db.Text

  @@index([sessionId])
  @@index([type])
  @@index([createdAt])
}

// C2Artifact: Generated artifact during C2 session
model C2Artifact {
  id          String        @id @default(cuid())
  createdAt   DateTime      @default(now())

  sessionId   String
  session     C2Session     @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  name        String
  type        C2ArtifactType
  contentJson Json?         // Artifact content/metadata
  filePath    String?       // Optional file path reference
  sizeBytes   Int?

  @@index([sessionId])
  @@index([type])
  @@index([createdAt])
}

enum C2SessionStatus {
  IDLE
  RUNNING
  PAUSED
  COMPLETED
  ABORTED
}

enum C2EventType {
  SESSION_START
  SESSION_STOP
  SESSION_ABORT
  AGENT_STATE
  PROGRESS
  LOG
  ARTIFACT_CREATED
  PING
}

enum C2AgentState {
  IDLE
  THINKING
  WORKING
  DONE
  ERROR
}

enum C2ArtifactType {
  CODE
  DOCUMENT
  CONFIG
  LOG
  REPORT
  OTHER
}

// ============================================================================
// AFC-ADAPTER-2: Adapter Registry
// ============================================================================

// Adapter: External runtime adapter registration (e.g., LangGraph host)
model Adapter {
  id           String   @id @default(cuid())
  name         String   @unique
  version      String
  baseUrl      String
  capabilities Json     @default("[]") // string[] of capability identifiers
  enabled      Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // AFC-ADAPTER-3: Health status fields
  lastSeenAt        DateTime?
  healthStatus      String    @default("UNKNOWN") // UNKNOWN | OK | UNREACHABLE
  lastHealthCheckAt DateTime?
  lastHealthError   String?   @db.VarChar(500) // Truncated error message

  @@index([enabled])
  @@index([name])
  @@index([healthStatus])
}

// ============================================================================
// AFC-QUOTE-0: Baseline Estimation Engine
// ============================================================================

// RateCard: Defines pricing rates for estimation
model RateCard {
  id        String   @id @default(cuid())
  name      String   // e.g. "US Standard Web Dev"
  currency  String   @default("USD")
  baseRate  Float    // hourly rate (e.g. 90)
  roles     Json     // { frontend: 1.0, backend: 1.1, devops: 1.2 }
  createdAt DateTime @default(now())

  @@index([name])
}

// Estimate: Generated cost estimate for a project scope
model Estimate {
  id          String   @id @default(cuid())
  userId      String
  sessionId   String?  // optional link to C2 session
  scopeJson   Json     // structured requirements
  effortHours Int
  minCost     Float
  maxCost     Float
  currency    String
  assumptions Json
  risks       Json
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
}

// ============================================================================
// AFC-ROUTER-INVENTORY-OSS-0: Internal Build Routing
// ============================================================================

// BuildPlan: Internal routing decision for how to build an application
// NOTE: This does NOT affect client pricing - it's internal optimization only
model BuildPlan {
  id         String   @id @default(cuid())
  userId     String
  sessionId  String?
  estimateId String?
  strategy   String // INVENTORY | INVENTORY_PLUS_OSS | OSS | CUSTOM
  coverage   Float // 0.0â€“1.0 estimated reuse coverage
  summary    String
  details    Json // breakdown of decisions
  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([sessionId])
}

// ============================================================================
// AFC-KIMI-ROUTER-0: Controlled Kimi Execution
// ============================================================================

// ExecutionEnvelope: Defines constraints for a Kimi execution run
// NOTE: This does NOT allow autonomous execution - strict budgets enforced
model ExecutionEnvelope {
  id            String   @id @default(cuid())
  userId        String
  buildPlanId   String
  provider      String // "kimi"
  maxCostUSD    Float
  maxAgents     Int
  maxRuntimeSec Int
  allowedScopes Json // e.g. ["custom_logic","integration_glue"]
  status        String // PENDING | RUNNING | COMPLETED | FAILED | CANCELLED
  createdAt     DateTime @default(now())

  @@index([userId])
  @@index([buildPlanId])
  @@index([status])
}

// KimiExecutionRun: Tracks a single Kimi execution run within an envelope
model KimiExecutionRun {
  id         String    @id @default(cuid())
  envelopeId String
  provider   String // "kimi"
  startedAt  DateTime
  finishedAt DateTime?
  tokensUsed Int?
  costUSD    Float?
  status     String // RUNNING | COMPLETED | FAILED
  summary    String?

  @@index([envelopeId])
  @@index([status])
}

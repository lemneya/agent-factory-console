  // AFC-1.4: Ralph Mode fields
  policy      RunPolicy?
  iterations  RunIteration[]
  abortReason RunAbortReason?
  ralphMode   Boolean         @default(false)
  createdAt   DateTime        @default(now())
  completedAt DateTime?

  @@index([threadId])
}

// AFC-1.1: RunCheckpoint for deterministic pause/resume
model RunCheckpoint {
  id           String         @id @default(cuid())
  runId        String
  run          Run            @relation(fields: [runId], references: [id], onDelete: Cascade)
  threadId     String         // MUST equal runId for AFC-1.1
  graphVersion String
  graphHash    String?
  checkpointId String
  nextNode     String?
  status       String         // RunStatus value
  stateJson    Json           // entire RunState "values" payload
  iterations   RunIteration[] // AFC-1.4: Iterations that created this checkpoint
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  @@index([runId])
  @@index([threadId])
}

model Task {
  id               String            @id @default(cuid())
  runId            String
  run              Run               @relation(fields: [runId], references: [id])
  title            String
  description      String?           @db.Text
  status           String            @default("TODO")
  priority         Int               @default(0)
  assignee         String?
  workerId         String?
  worker           Worker?           @relation(fields: [workerId], references: [id])
  result           Json?
  errorMsg         String?           @db.Text
  startedAt        DateTime?
  completedAt      DateTime?
  // AFC-1.1: Queue lease self-healing fields
  claimedBy        String?           // worker ID that claimed this task
  claimedAt        DateTime?         // when the task was claimed
  leaseExpiresAt   DateTime?         // when the lease expires (reclaimable after)
  attempts         Int               @default(0) // number of claim attempts
  // AFC-1.3: Council decision link
  councilDecisions CouncilDecision[]
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  @@index([status])
  @@index([leaseExpiresAt])
}

// Worker model for Agent B implementation
// Workers are AI agents that can claim and execute tasks
model Worker {
  id           String    @id @default(cuid())
  name         String
  type         String    @default("AGENT")
  status       String    @default("IDLE")
  capabilities String[]
  metadata     Json?
  lastHeartbeat DateTime @default(now())
  currentTaskId String?  @unique
  tasks        Task[]
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
--
// AFC-1.4: Ralph Mode Runner Models
// ============================================================================

// RunPolicy: Stores loop/budget rules per run
model RunPolicy {
  id                      String   @id @default(cuid())
  runId                   String   @unique
  run                     Run      @relation(fields: [runId], references: [id], onDelete: Cascade)
  maxIterations           Int      @default(25)
  maxWallClockSeconds     Int      @default(14400) // 4 hours
  maxFailures             Int      @default(10)
  maxRepeatedError        Int      @default(3)
  maxNoProgressIterations Int      @default(5)
  requireHumanApprovalAt  Json?    // e.g. ["plan_review","pre_merge"]
  verificationCommands    Json     @default("[\"npm run lint\",\"npm test\",\"npm run build\"]")
  completionPromise       String   @default("<AFC_DONE/>")
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
}

// RunIteration: Tracks each loop attempt
model RunIteration {
  id                  String           @id @default(cuid())
  runId               String
  run                 Run              @relation(fields: [runId], references: [id], onDelete: Cascade)
  iteration           Int
  status              IterationStatus  @default(RUNNING)
  startedAt           DateTime         @default(now())
  endedAt             DateTime?
  verificationSummary Json?            // { lint: pass/fail, test: pass/fail, build: pass/fail }
  errorFingerprint    String?          // hash of top error for thrash detection
  diffStats           Json?            // { files: n, insertions: n, deletions: n }
  checkpointId        String?
  checkpoint          RunCheckpoint?   @relation(fields: [checkpointId], references: [id])
  createdAt           DateTime         @default(now())

  @@unique([runId, iteration])
  @@index([runId])
  @@index([errorFingerprint])
}

// RunAbortReason: Records why run was aborted
model RunAbortReason {
  id        String      @id @default(cuid())
  runId     String      @unique
  run       Run         @relation(fields: [runId], references: [id], onDelete: Cascade)
  reason    AbortReason
  details   Json?
  createdAt DateTime    @default(now())
}

